<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Linux_SDK_Guide/guide | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="#Ecoli AM5728平台开发指引 宋振豪[TOC] 1. 编译1.1. u-boot编译make ARCH=arm CROSS_COMPILE=~&#x2F;ti-processor-sdk-linux-am57xx-evm-04.01.00.06&#x2F;linux-devkit&#x2F;sysroots&#x2F;x86_64-arago-linux&#x2F;usr&#x2F;bin&#x2F;arm-linux-gnueabihf- am57xx_">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux_SDK_Guide&#x2F;guide">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;10&#x2F;18&#x2F;Linux_SDK_Guide&#x2F;guide&#x2F;index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="#Ecoli AM5728平台开发指引 宋振豪[TOC] 1. 编译1.1. u-boot编译make ARCH=arm CROSS_COMPILE=~&#x2F;ti-processor-sdk-linux-am57xx-evm-04.01.00.06&#x2F;linux-devkit&#x2F;sysroots&#x2F;x86_64-arago-linux&#x2F;usr&#x2F;bin&#x2F;arm-linux-gnueabihf- am57xx_">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;10&#x2F;18&#x2F;Linux_SDK_Guide&#x2F;guide&#x2F;1.PNG">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;10&#x2F;18&#x2F;Linux_SDK_Guide&#x2F;guide&#x2F;boot_strapping.PNG">
<meta property="og:updated_time" content="2019-10-17T07:35:33.499Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;10&#x2F;18&#x2F;Linux_SDK_Guide&#x2F;guide&#x2F;1.PNG">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Linux_SDK_Guide/guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/18/Linux_SDK_Guide/guide/" class="article-date">
  <time datetime="2019-10-18T09:20:22.359Z" itemprop="datePublished">2019-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux_SDK_Guide/guide
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#<strong><center>Ecoli AM5728平台开发指引</center></strong><br><strong><p align="right"> 宋振豪</p></strong><br>[TOC]</p>
<h2 id="1-编译"><a href="#1-编译" class="headerlink" title="1. 编译"></a>1. 编译</h2><h3 id="1-1-u-boot编译"><a href="#1-1-u-boot编译" class="headerlink" title="1.1. u-boot编译"></a>1.1. u-boot编译</h3><p>make ARCH=arm CROSS_COMPILE=~/ti-processor-sdk-linux-am57xx-evm-04.01.00.06/linux-devkit/sysroots/x86_64-arago-linux/usr/bin/arm-linux-gnueabihf- am57xx_evm_defconfig </p>
<h3 id="1-2-内核编译"><a href="#1-2-内核编译" class="headerlink" title="1.2. 内核编译"></a>1.2. 内核编译</h3><h4 id="1-2-1-源码默认config"><a href="#1-2-1-源码默认config" class="headerlink" title="1.2.1 源码默认config"></a>1.2.1 源码默认config</h4><p>arch/arm/configs/tisdk_am57xx-evm_defconfig</p>
<h4 id="1-2-2-系统原有config"><a href="#1-2-2-系统原有config" class="headerlink" title="1.2.2 系统原有config"></a>1.2.2 系统原有config</h4><p>/proc/config.gz，可获取config。如果没有这个节点的话则需要先加载模块：sudo modprobe configs。zcat config.gz &gt; .config</p>
<h3 id="1-3-文件系统编译-yocto"><a href="#1-3-文件系统编译-yocto" class="headerlink" title="1.3. 文件系统编译/yocto"></a>1.3. 文件系统编译/yocto</h3><h4 id="1-3-1-环境准备"><a href="#1-3-1-环境准备" class="headerlink" title="1.3.1. 环境准备"></a>1.3.1. 环境准备</h4><ul>
<li><ol>
<li>软件依赖<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sudo apt-get install git build-essential python diffstat texinfo gawk chrpath dos2unix wget unzip socat doxygen libc6:i386 libncurses5:i386 libstdc++6:i386 libz1:i386</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="2">
<li>切bash<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sudo dpkg-reconfigure dash</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="3">
<li>交叉工具链<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz</span><br><span class="line">$ tar -Jxvf gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf.tar.xz -C $HOME</span><br><span class="line">$ wget https://developer.arm.com/-/media/Files/downloads/gnu-a/8.3-2019.03/binrel/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz</span><br><span class="line">$ tar -Jxvf gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu.tar.xz -C $HOME</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="4">
<li>编译<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git://arago-project.org/git/projects/oe-layersetup.git tisdk</span><br><span class="line">$ cd tisdk</span><br><span class="line">$ ./oe-layertool-setup.sh -f configs/processor-sdk/processor-sdk-&lt;version&gt;-config.txt</span><br><span class="line">$ cd build</span><br><span class="line">$ . conf/setenv</span><br><span class="line">$ export TOOLCHAIN_PATH_ARMV7=$HOME/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf</span><br><span class="line">$ export TOOLCHAIN_PATH_ARMV8=$HOME/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu</span><br><span class="line">$ MACHINE=am57xx-evm bitbake arago-base-tisdk-image</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">Target</th>
<th align="left">Build Output</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">arago-core-tisdk-image</td>
<td align="left">images/&lt;machine&gt;/processor-sdk-linux-image-&lt;machine&gt;.tar.xz</td>
<td align="left">Full SDK</td>
</tr>
<tr>
<td align="left">tisdk-rootfs-image</td>
<td align="left">images/&lt;machine&gt;/tisdk-rootfs-image-&lt;machine&gt;.tar.xz</td>
<td align="left">Target Filesystem</td>
</tr>
<tr>
<td align="left">arago-base-tisdk-image</td>
<td align="left">images/&lt;machine&gt;/arago-base-tisdk-image-&lt;machine&gt;.tar.xz</td>
<td align="left">Minimal Target Filesytem</td>
</tr>
<tr>
<td align="left">meta-toolchaino-arago-tisdk</td>
<td align="left">sdk/arago-&lt;arago-version&gt;-&lt;architecture&gt;.sh</td>
<td align="left">Devkit</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
<li><ol start="5">
<li>RT build<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MACHINE=&lt;machine&gt; ARAGO_RT_ENABLE=1 bitbake &lt;target&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ul>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h2><h3 id="2-1-新机器固件烧录"><a href="#2-1-新机器固件烧录" class="headerlink" title="2.1. 新机器固件烧录"></a>2.1. 新机器固件烧录</h3><h3 id="2-2-tftpboot-amp-nfs"><a href="#2-2-tftpboot-amp-nfs" class="headerlink" title="2.2. tftpboot&amp;nfs"></a>2.2. tftpboot&amp;nfs</h3><h3 id="2-3-文件系统打包及升级"><a href="#2-3-文件系统打包及升级" class="headerlink" title="2.3. 文件系统打包及升级"></a>2.3. 文件系统打包及升级</h3><h3 id="2-4-内核升级"><a href="#2-4-内核升级" class="headerlink" title="2.4. 内核升级"></a>2.4. 内核升级</h3><h4 id="2-4-1-替换内核设备树"><a href="#2-4-1-替换内核设备树" class="headerlink" title="2.4.1 替换内核设备树"></a>2.4.1 替换内核设备树</h4><p>替换板卡目录/boot/下的zImage和dtb文件</p>
<h4 id="2-4-2-驱动模块替换"><a href="#2-4-2-驱动模块替换" class="headerlink" title="2.4.2 驱动模块替换"></a>2.4.2 驱动模块替换</h4><p>打包到一个目录<br>make ARCH=arm INSTALL_MOD_PATH=$path modules_install</p>
<p>拷贝$path /lib目录</p>
<h4 id="2-4-3-驱动编译"><a href="#2-4-3-驱动编译" class="headerlink" title="2.4.3 驱动编译"></a>2.4.3 驱动编译</h4><p>*.mod.c文件生成：<br>scripts/mod/modpost.c<br>modpost 被 scripts/Makefile.modpost 调用，生成 <module>.mod.c 及文件 Module.symvers</p>
<h2 id="3-运行"><a href="#3-运行" class="headerlink" title="3. 运行"></a>3. 运行</h2><h3 id="3-1-应用启动脚本编写"><a href="#3-1-应用启动脚本编写" class="headerlink" title="3.1 应用启动脚本编写"></a>3.1 应用启动脚本编写</h3><h3 id="3-2-文件系统裁剪"><a href="#3-2-文件系统裁剪" class="headerlink" title="3.2 文件系统裁剪"></a>3.2 文件系统裁剪</h3><h4 id="3-2-1-opkg-配置"><a href="#3-2-1-opkg-配置" class="headerlink" title="3.2.1 opkg 配置"></a>3.2.1 opkg 配置</h4><p>bitbake package-index 生成opkg packege</p>
<p>1 apache 配置opkg server:<br>apt-install apache2<br>sudo ln -s /home/songzhenhao/ipk/ /var/www/html/ipk_repo #把ipk包拷贝到该目录下<br>2 yocto build/conf/local.conf<br>EXTRA_IMAGE_FEATURES = “debug-tweaks package-managment”<br>3 板卡配置文件/etc/opkg/opkg.conf<br>dest root /<br>option lists_dir /var/lib/opkg/lists<br>src/gz all <a href="http://172.16.82.197/ipk_repo/ipk/all" target="_blank" rel="noopener">http://172.16.82.197/ipk_repo/ipk/all</a><br>src/gz am57xx_evm <a href="http://172.16.82.197/ipk_repo/ipk/am57xx_evm" target="_blank" rel="noopener">http://172.16.82.197/ipk_repo/ipk/am57xx_evm</a><br>src/gz armv7ahf-neon <a href="http://172.16.82.197/ipk_repo/ipk/armv7ahf-neon" target="_blank" rel="noopener">http://172.16.82.197/ipk_repo/ipk/armv7ahf-neon</a><br>src/gz armv7at2hf-neon <a href="http://172.16.82.197/ipk_repo/ipk/armv7at2hf-neon" target="_blank" rel="noopener">http://172.16.82.197/ipk_repo/ipk/armv7at2hf-neon</a></p>
<h2 id="4-other"><a href="#4-other" class="headerlink" title="4.other"></a>4.other</h2><p>linux-RT 比LinuxSDK 多了个rt preempt</p>
<h2 id="5-启动流程"><a href="#5-启动流程" class="headerlink" title="5.启动流程"></a>5.启动流程</h2><p>  printf(“%s %s %d\n”, <strong>FILE</strong>, <strong>FUNCTION</strong>, <strong>LINE</strong>);   </p>
<h3 id="5-1-SPL"><a href="#5-1-SPL" class="headerlink" title="5.1.SPL"></a>5.1.SPL</h3><p>入口函数:save_boot_params()<br>/arch/arm/cpu/armv7/start.S<br>reset:<br>b save_boot_params<br>//arch/arm/mach-omap2/<br>save_boot_params()<br>//arch/arm/mach-tegra/board.c/save_boot_params()<br>-&gt;save_boot_params_ret()<br>-&gt;switch_to_hypervisor()</p>
<p>__main() //arch/arm/lib/crt0.S<br>    -&gt;board_init_f()<br>    -&gt;board_init_r()</p>
<p><del>efi_main() //lib/efi/efi_app.c</del><br>initr_bootstage()-&gt;bootstage_mark_name()//common/board_r.c<br>-&gt;board_init_r() //common/spl/spl.c<br>-&gt;spl_board_init() // arch/arm/mach-omap2/boot-common.c<br>    -&gt;preloader_console_init() //print U-Boot SPL … /common/spl/spl.c<br>    -&gt;board_init() //board/ti/am57xx/board.c</p>
<p>ti_i2c_eeprom_am_get() //board/ti/common/board_detect.c</p>
<p>board_init_r()-&gt;boot_from_devices()//common/spl/spl.c //Trying to boot from MMC1</p>
<p>load_image-&gt;spl_mmc_load_image()//spl_mmc_load_image<br>arch/arm/mach-omap2/boot-common.c:spl_boot_mode()<br>spl_mmc_load_image()-&gt;spl_mmc_do_fs_boot()<br>    -&gt;spl_start_boot()//board/ti/am57xx/board.c return 1<br>    -&gt;spl_load_image_fat()//common/spl/spl_fat.c<br>        -&gt;spl_load_simple_fit()//common/spl/spl_fit.c</p>
<p>spl_load_simple_fit()///common/spl/spl_fit.c<br>-&gt;fit_select_fdt()//common/common_fit.c //No matching DT out of these options:<br>-&gt;board_fit_config_name_match()/<em>./board/ti/am57xx/board.c</em>/-&gt;board_ti_is()<br>    TI_EEPROM_DATA:0x4037bc28</p>
<p>board_init_f()-&gt;early_system_init() //arch/arm/mach-omap2/hwinit-common.c<br>do_board_detect() //board/ti/am57xx/board.c<br>-&gt;ti_i2c_eeprom_am_get()填充TI_EEPROM_DATA指向的ram</p>
<p><del>spl_relocate_stack_gd</del><br>board_init_f_alloc_reserve</p>
<p><strong>spl跳转u-boot：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">board_init_r() /common/spl/spl.c</span><br><span class="line">-&gt; boot_from_devices(&amp;spl_image, spl_boot_list,...)// 填充spl_image</span><br><span class="line">   return struct spl_image_loader </span><br><span class="line">   /commom/spl/spl_mmc.c</span><br><span class="line">   SPL_LOAD_IMAGE_METHOD(&quot;MMC1&quot;, 0, BOOT_DEVICE_MMC1, spl_mmc_load_image)</span><br><span class="line">   -&gt;spl_load_image(spl_image,loader)-&gt;loader.load_image(spl_image,...)</span><br><span class="line">      -&gt;spl_mmc_load_image() common/spl/spl_mmc.c   </span><br><span class="line">         -&gt;spl_mmc_load()</span><br><span class="line">-&gt;jump_to_image_no_args(&amp;spl_image);</span><br></pre></td></tr></table></figure>

<p><strong>u-boot</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">board_init_f()/common/board_f.c</span><br><span class="line">board_init_r()-&gt;initcall_run_list(init_sequence_r)-&gt;run_main_loop()-&gt;main_loop()</span><br><span class="line">-&gt;bootdelay_process()//env_get(&quot;bootcmd)</span><br><span class="line">-&gt;autoboot_command()</span><br><span class="line">   -&gt;abortboot(stored_bootdelay) </span><br><span class="line">   -&gt;run_command_list()</span><br><span class="line">      -&gt;parse_string_outer(buff, FLAG_PARSE_SEMICOLON)</span><br><span class="line">         -&gt;setup_string_in_str(&amp;input, s)</span><br><span class="line">         -&gt;parse_stream_outer(&amp;input, flag)</span><br><span class="line">               -&gt;cmd_process()</span><br><span class="line">                  -&gt;find_cmd()</span><br><span class="line">                  -&gt;cmd_call()</span><br><span class="line">      -&gt;board_run_command(buff) //do not run here</span><br><span class="line">-&gt;cli_loop()</span><br><span class="line">   -&gt;parse_file_outer()</span><br><span class="line">      -&gt;parse_stream_outer()</span><br><span class="line">         -&gt;parse_stream()</span><br><span class="line">         -&gt;run_list()</span><br><span class="line">            -&gt;run_list_real()</span><br><span class="line">               -&gt;run_pipe_real()</span><br><span class="line">                  -&gt;cmd_process()</span><br><span class="line">                     -&gt;find_cmd()</span><br><span class="line">                     -&gt;cmd_call()</span><br></pre></td></tr></table></figure>

<p><strong>GD内存分配和初始化</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">reset:/arch/arm/cpu/armv7/start.S</span><br><span class="line">-&gt;save_boot_params /start.s</span><br><span class="line">   -&gt;save_boot_params_ret</span><br><span class="line">      -&gt;switch_to_hypervisor</span><br><span class="line">         -&gt;cpu_init_cp15</span><br><span class="line">         -&gt;cpu_init_crit /lowlevel_init.S</span><br><span class="line">         -&gt;__main /arch/arm/lib/crt0.S</span><br><span class="line">            -&gt;ldr r0, = (CONFIG_SYS_INIT_SP_ADDR=NON_SECURE_SRAM_END-GENERATED_GBL_DATA_SIZE) 0x4037ff20</span><br><span class="line">               #define NON_SECURE_SRAM_END 0x40380000</span><br><span class="line">               #define GENERATED_GBL_DATA_SIZE 224 /*(sizeof(struct global_data)+15) &amp; ~15*/</span><br><span class="line">            -&gt;board_oinit_f_alloc_reserve /common/init/board_init.c</span><br><span class="line">            -&gt;move r9, r0 /set up gd</span><br><span class="line">            -&gt;board_init_f /arch/arm/mach-omap2/hwinit-common.c</span><br><span class="line">            -&gt;board_init_r /common/spl/spl.c</span><br></pre></td></tr></table></figure>


<p>#define DECLARE_GLOBAL_DATA_PTR  register volatile gd_t *gd asm (“r9”) //arch/arm/include/asm/global_data.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TI_SRAM_SCRATCH_BOARD_EEPROM_START (SRAM_SCRATCH_SPACE_ADDR + 0x28) <span class="comment">//0x4037bc28</span></span></span><br><span class="line"><span class="comment">//arch/arm/include/asm/arch-omap5/omap.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_DRA7XX)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_START›  0x40300000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_END›0x40380000› <span class="comment">/* Not inclusive */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_IMG_END›0x4037C000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_START›  0x40300000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_END›0x40320000› <span class="comment">/* Not inclusive */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_SECURE_SRAM_IMG_END›0x4031E000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRAM_SCRATCH_SPACE_ADDR›(NON_SECURE_SRAM_IMG_END - SZ_1K) <span class="comment">//0x4037bc00</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//include/linux/sizes.h:22</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SZ_1K 0x00000400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//arch/arm/mach-omap2/boot-common.c:save_omap_boot_params()-&gt; NON_SECURE_SRAM_START</span></span><br><span class="line"><span class="comment">//arch/arm/mach-omap2/hwinit-common.c:early_system_init()-&gt;save_omap_boot_params()</span></span><br><span class="line">board_init_f()-&gt;early_system_init()</span><br><span class="line">arch_cpu_init_dm()-&gt;early_system_init()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//board/ti/am57xx/board.c</span></span><br><span class="line">do_board_detect()-&gt;ti_i2c_eeprom_am_get()</span><br></pre></td></tr></table></figure>
<h3 id="spl-gt-u-boot"><a href="#spl-gt-u-boot" class="headerlink" title="spl-&gt;u-boot"></a>spl-&gt;u-boot</h3><p>SPL:<br>board_init_r() //common/spl/spl.c<br>-&gt;jump_to_image_no_args() //jump to u-boot<br>U-Boot:<br>board_init_r() //common/board_r.c<br>-&gt; initcall_run_list(init_sequece_r)</p>
<p>新板卡启动失败问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//board/ti/common/board_detect.c</span></span><br><span class="line"><span class="comment">//ti_i2c_eeprom_am_get(int bus_addr, int dev_addr)</span></span><br><span class="line">-       rc = ti_i2c_eeprom_get(bus_addr, dev_addr, TI_EEPROM_HEADER_MAGIC,</span><br><span class="line">-                              <span class="keyword">sizeof</span>(am_ep), (<span class="keyword">uint8_t</span> *)&amp;am_ep);</span><br><span class="line">-       <span class="keyword">if</span> (rc)</span><br><span class="line">-               <span class="keyword">return</span> rc;</span><br><span class="line">+<span class="comment">//     rc = ti_i2c_eeprom_get(bus_addr, dev_addr, TI_EEPROM_HEADER_MAGIC,</span></span><br><span class="line">+<span class="comment">//                            sizeof(am_ep), (uint8_t *)&amp;am_ep);</span></span><br><span class="line">+<span class="comment">//     if (rc)</span></span><br><span class="line">+<span class="comment">//             return rc;</span></span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+    ep-&gt;header = TI_EEPROM_HEADER_MAGIC;</span><br><span class="line">+    <span class="built_in">memcpy</span>(ep-&gt;name, <span class="string">"BBRDX15_"</span>, <span class="number">9</span>);</span><br><span class="line">+    <span class="built_in">memcpy</span>(ep-&gt;version, <span class="string">"C.00"</span>, <span class="number">5</span>);</span><br><span class="line">+    <span class="built_in">memcpy</span>(ep-&gt;serial, <span class="string">"1739PX150598"</span>, <span class="built_in">strlen</span>(<span class="string">"1739PX150598"</span>));</span><br><span class="line">+    ep-&gt;emif1_size = <span class="number">0xfdf1fc74</span>;</span><br><span class="line">+    ep-&gt;emif2_size = <span class="number">0x5585f6c8</span>;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+</span><br><span class="line">+</span><br></pre></td></tr></table></figure>
<h3 id="uboot-引导MMC-加载uEnv-txt"><a href="#uboot-引导MMC-加载uEnv-txt" class="headerlink" title="uboot 引导MMC,加载uEnv.txt"></a>uboot 引导MMC,加载uEnv.txt</h3><p><a href="http://processors.wiki.ti.com/index.php/AM335x_U-Boot_User%27s_Guide" target="_blank" rel="noopener">http://processors.wiki.ti.com/index.php/AM335x_U-Boot_User%27s_Guide</a><br>uEnv.txt<br>bootargs=console=ttyO2,115200n8 root=PARTUUID=b6f20031-02 rw rootfstype=ext4 rootwait libata.force=noncq</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span></span><br><span class="line">setenv mmcdev <span class="number">1</span></span><br><span class="line">setenv bootpart <span class="number">1</span>:<span class="number">2</span></span><br><span class="line">run loadbootenv </span><br><span class="line">run importbootenv</span><br><span class="line">run findfdt</span><br><span class="line">run envboot</span><br><span class="line">setenv mmcroot /dev/mmcblk1p2 rw</span><br><span class="line">setenv devnum <span class="number">1</span> </span><br><span class="line">setenv devtype mmc </span><br><span class="line">run loadimage</span><br><span class="line">run finduuid</span><br><span class="line">run loadfdt</span><br><span class="line">bootz $&#123;loadaddr&#125; - $&#123;fdtaddr&#125;</span><br></pre></td></tr></table></figure>

<h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><h3 id="journal-日志文件存储"><a href="#journal-日志文件存储" class="headerlink" title="journal 日志文件存储"></a>journal 日志文件存储</h3><p><a href="https://www.cnblogs.com/sparkdev/p/8795141.html" target="_blank" rel="noopener">https://www.cnblogs.com/sparkdev/p/8795141.html</a><br>/etc/systemd/journald.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Storage=auto // or persistent /日志文件存储在/var/log/journal</span><br><span class="line">SystemMaxUse=200M //journal 文件空间最大200M</span><br></pre></td></tr></table></figure>
<p>/etc/fstab</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#tmpfs /var/volatile ..... //注释var/volatile,journal 保存磁盘目录</span><br></pre></td></tr></table></figure>


<h2 id="DT设备树"><a href="#DT设备树" class="headerlink" title="DT设备树"></a>DT设备树</h2><p>ethernet@48484000</p>
<h3 id="beagleboard-x15设备树去网卡"><a href="#beagleboard-x15设备树去网卡" class="headerlink" title="beagleboard-x15设备树去网卡"></a>beagleboard-x15设备树去网卡</h3><p>ethernet节点去除：<br>slaves = &lt;0x01&gt;<br>dual_emac;<br>slave@48480300 {<br>    。。。。。<br>}<br>假设我们最终的设备树文件是：arch/arm/boot/dts/s3c2416-smdk2416.dtb</p>
<p>./scripts/dtc/dtc -I dtb -O dts -o output.dts arch/arm/boot/dts/s3c2416-smdk2416.dtb<br>输出文件output.dts就是反汇编的结果，他就是实际生成的设备树，当然也可以重新将生成的dts文件在编译成dtb文件：</p>
<p>./scripts/dtc/dtc -I dts -O dtb -o s3c2416-smdk2416.dtb output.dts</p>
<h2 id="网卡调试-cpsw"><a href="#网卡调试-cpsw" class="headerlink" title="网卡调试(cpsw)"></a>网卡调试(cpsw)</h2><p>_cpsw_adjust_link() //drivers/net/ethernet/ti/cpsw.c<br>-&gt;phy_print_status() //drivers/net/phy/phy.c</p>
<p>drivers/net/phy/phy.c phy_state_machine()<br>sta:<br>4-&gt;5-&gt;7-&gt;6(connected)</p>
<p>printk(KERN_INFO “%s %s %d:”, <strong>FILE</strong>, <strong>funtion</strong>, <strong>LINE</strong>);</p>
<p>phy_state_machine()-&gt;phydev-&gt;adjust_link()-&gt;cpsw_adjust_link()</p>
<p>static inline int phy_read_status(struct phy_device *phydev)<br>{<br>    return phydev-&gt;drv-&gt;read_status(phydev);<br>}</p>
<p>struct phy_device{} -&gt; struct phy_driver *drv<br>struct phy_driver {} -&gt; read_status()-&gt;ksz9031_read_status()/drivers/net/phy/micrel.c</p>
<p>genphy_read_status()-&gt;<br>genphy_update_link()//drivers/net/phy/phy_device.c<br>    -&gt;phy_read() //include/linux/phy.h<br>        -&gt;mdiobus_read()//drivers/net/phy/mdio_bus.c<br>            -&gt;davinci_mdio_read()/drivers/net/ethernet/ti/davinci_mdio.c<br>    phydev-&gt;link = 1;</p>
<p>KSZ9031寄存器操作：<br>读 0x01 IEEE-Defined Registers Basic Status 判断是否连接上设备；<br>默认读取为：0x7949<br>conneted: 0x796d “Auto-Negotiation Complete” and “Link Status” was setted</p>
<h2 id="UVC调试"><a href="#UVC调试" class="headerlink" title="UVC调试"></a>UVC调试</h2><h2 id="RTC"><a href="#RTC" class="headerlink" title="RTC"></a>RTC</h2><p>/etc/systemd/systemd/sync-clocks.service<br>ExecStart=/sbin/hwclock –hctosys –utc</p>
<p>##<br><img src="1.PNG" alt=""><br><img src="boot_strapping.PNG" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@startgantt</span><br><span class="line"></span><br><span class="line">Project starts the 1st of May 2019</span><br><span class="line">[AM5728 PCIe驱动预研与可信性分析(宋振豪)] as [TASK1] lasts 14 days</span><br><span class="line">[TASK1] is colored in Lavender/LightBlue</span><br><span class="line">[AM5728 PCIe转接板打板(陈清四)] as [TASK2] lasts 17 days</span><br><span class="line">[AM5728 PCIe驱动开发(宋振豪)] as [TASK3] lasts 17 days</span><br><span class="line">[TASK3] is colored in Lavender/LightBlue</span><br><span class="line">[TASK1] -&gt; [TASK2]</span><br><span class="line">[TASK1] -&gt; [TASK3]</span><br><span class="line">then [AM5728 PCIe驱动开发/测试,接入已有的FPGA板卡(宋振豪)] as [TASK4] lasts 30 days</span><br><span class="line">[TASK4] is colored in Lavender/LightBlue</span><br><span class="line"></span><br><span class="line">@endgantt</span><br></pre></td></tr></table></figure>
<h2 id="编译xdma"><a href="#编译xdma" class="headerlink" title="编译xdma"></a>编译xdma</h2><ul>
<li>安装libelf-dev</li>
<li>替换函数pci_enable_msix()为pci_enable_msix_exac<br>交叉编译：<br>改Makefile KERNELDIR为AM5728内核源码路径<br>make ARCH=arm CROSS_COMPILE=….</li>
</ul>
<h2 id="Platform-Framework"><a href="#Platform-Framework" class="headerlink" title="Platform Framework"></a>Platform Framework</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> &#123;</span></span><br><span class="line">   <span class="keyword">int</span> (*probe)(struct platform_device *);</span><br><span class="line">   <span class="keyword">int</span> (*remove)(struct platform_device *);</span><br><span class="line">   <span class="keyword">void</span> (*shutdown)(struct platform_device *);</span><br><span class="line">   <span class="keyword">int</span> (*suspend)(struct platform_device *, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">   <span class="keyword">int</span> (*resume)(struct platform_device *);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line">   <span class="keyword">bool</span> prevent_deferred_probe;</span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> &#123;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">   <span class="keyword">int</span>   id;</span><br><span class="line">   <span class="keyword">bool</span>  id_auto;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device</span>  <span class="title">dev</span>;</span></span><br><span class="line">   u32    num_resources;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">resource</span>›*<span class="title">resource</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span>›*<span class="title">id_entry</span>;</span></span><br><span class="line">   <span class="keyword">char</span> *driver_override; <span class="comment">/* Driver name to force a match */</span></span><br><span class="line">   <span class="comment">/* MFD cell pointer */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">mfd_cell</span> *<span class="title">mfd_cell</span>;</span></span><br><span class="line">   <span class="comment">/* arch specific additions */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pdev_archdata</span>   <span class="title">archdata</span>;</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> &#123;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span>   *name;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span>   *<span class="title">bus</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">module</span>   *<span class="title">owner</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span>   *mod_name;› <span class="comment">/* used for built-in modules */</span></span><br><span class="line">   <span class="keyword">bool</span> suppress_bind_attrs;  <span class="comment">/* disables bind/unbind via sysfs */</span></span><br><span class="line">   <span class="keyword">enum</span> probe_type probe_type;</span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span>  *<span class="title">of_match_table</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">acpi_device_id</span> *<span class="title">acpi_match_table</span>;</span></span><br><span class="line">   <span class="keyword">int</span> (*probe) (struct device *dev);</span><br><span class="line">   <span class="keyword">int</span> (*remove) (struct device *dev);</span><br><span class="line">   <span class="keyword">void</span> (*shutdown) (struct device *dev);</span><br><span class="line">   <span class="keyword">int</span> (*suspend) (struct device *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">   <span class="keyword">int</span> (*resume) (struct device *dev);</span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">driver_private</span> *<span class="title">p</span>;</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device</span>     *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_private</span>  *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span>    *init_name; <span class="comment">/* initial name of the device */</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_type</span> *<span class="title">type</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>      <span class="title">mutex</span>;</span> <span class="comment">/* mutex to synchronize calls to</span></span><br><span class="line"><span class="comment">                * its driver.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span>*<span class="title">bus</span>;</span>     <span class="comment">/* type of bus device is on */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> *<span class="title">driver</span>;</span>  <span class="comment">/* which driver has allocated this</span></span><br><span class="line"><span class="comment">                  device */</span></span><br><span class="line">   <span class="keyword">void</span>      *platform_data;<span class="comment">/* Platform specific data, device</span></span><br><span class="line"><span class="comment">                  core doesn't touch it */</span></span><br><span class="line">   <span class="keyword">void</span>      *driver_data;  <span class="comment">/* Driver data, set and get with</span></span><br><span class="line"><span class="comment">                  dev_set/get_drvdata */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dev_links_info</span>  <span class="title">links</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_info</span> <span class="title">power</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_domain</span>   *<span class="title">pm_domain</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_MSI_IRQ_DOMAIN</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span>  *<span class="title">msi_domain</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span>*<span class="title">pins</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_MSI_IRQ</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>   <span class="title">msi_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">   <span class="keyword">int</span>   numa_node; <span class="comment">/* NUMA node this device is close to */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   u64   *dma_mask; <span class="comment">/* dma mask (if dma'able device) */</span></span><br><span class="line">   u64   coherent_dma_mask;<span class="comment">/* Like dma_mask, but for</span></span><br><span class="line"><span class="comment">                    alloc_coherent mappings as</span></span><br><span class="line"><span class="comment">                    not all hardware supports</span></span><br><span class="line"><span class="comment">                    64 bit addresses for consistent</span></span><br><span class="line"><span class="comment">                    allocations such descriptors. */</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span>  dma_pfn_offset;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_dma_parameters</span> *<span class="title">dma_parms</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>   <span class="title">dma_pools</span>;</span> <span class="comment">/* dma pools (if dma'ble) */</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dma_coherent_mem</span>*<span class="title">dma_mem</span>;</span> <span class="comment">/* internal for coherent mem</span></span><br><span class="line"><span class="comment">                    override */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DMA_CMA</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">cma</span> *<span class="title">cma_area</span>;</span>     <span class="comment">/* contiguous memory area for dma</span></span><br><span class="line"><span class="comment">                  allocations */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   <span class="comment">/* arch specific additions */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dev_archdataarchdata</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span> <span class="comment">/* associated device tree node */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span>   *<span class="title">fwnode</span>;</span> <span class="comment">/* firmware device node */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">dev_t</span>        devt;  <span class="comment">/* dev_t, creates the sysfs "dev" */</span></span><br><span class="line">   u32      id;<span class="comment">/* device instance */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">spinlock_t</span>    devres_lock;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>   <span class="title">devres_head</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">klist_node</span>  <span class="title">knode_class</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">class</span>      *<span class="title">class</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span> <span class="comment">/* optional groups */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span>   (*release)(struct device *dev);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">iommu_group</span> *<span class="title">iommu_group</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">iommu_fwspec</span>*<span class="title">iommu_fwspec</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">bool</span>         offline_disabled:<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">bool</span>         offline:<span class="number">1</span>;</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">platform_bus_type</span> = &#123;</span></span><br><span class="line">   .name       = <span class="string">"platform"</span>,</span><br><span class="line">   .dev_groups = platform_dev_groups,</span><br><span class="line">   .match      = platform_match,</span><br><span class="line">   .uevent     = platform_uevent,</span><br><span class="line">   .pm         = &amp;platform_dev_pm_ops,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL_GPL(platform_bus_type);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> &#123;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span>      *name;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span>      *dev_name;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device</span>       *<span class="title">dev_root</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span>›*<span class="title">dev_attrs</span>;</span>›<span class="comment">/* use dev_groups instead */</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">bus_groups</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">drv_groups</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> (*match)(struct device *dev, struct device_driver *drv);</span><br><span class="line">   <span class="keyword">int</span> (*uevent)(struct device *dev, struct kobj_uevent_env *env);</span><br><span class="line">   <span class="keyword">int</span> (*probe)(struct device *dev);</span><br><span class="line">   <span class="keyword">int</span> (*remove)(struct device *dev);</span><br><span class="line">   <span class="keyword">void</span> (*shutdown)(struct device *dev);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> (*online)(struct device *dev);</span><br><span class="line">   <span class="keyword">int</span> (*offline)(struct device *dev);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> (*suspend)(struct device *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">   <span class="keyword">int</span> (*resume)(struct device *dev);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iommu_ops</span> *<span class="title">iommu_ops</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">lock_key</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __platform_driver_register - register a driver for platform-level devices </span></span><br><span class="line"><span class="comment"> * @drv: platform driver structur</span></span><br><span class="line"><span class="comment"> * @owner: owning module/driver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> __platform_driver_register(struct platform_driver *drv, struct <span class="keyword">module</span> *owner)&#123;</span><br><span class="line">    drv-&gt;driver.owner = owner;</span><br><span class="line">    drv-&gt;driver.bus = &amp;platform_bus_type;</span><br><span class="line">    drv-&gt;driver.probe = platform_drv_probe;</span><br><span class="line">    drv-&gt;driver.remove = platform_drv_remove;</span><br><span class="line">    drv-&gt;driver.shutdown = platform_drv_shutdown;</span><br><span class="line">    <span class="keyword">return</span> driver_register(&amp;drv-&gt;driver);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(__platform_driver_register);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">字面理解：将某个platform的driver注册到platform中；</span></span><br><span class="line"><span class="comment">这个platform_driver *drv中probe函数的调用：</span></span><br><span class="line"><span class="comment">    drv-&gt;driver.probe-&gt;platform_drv_probe //sturct device_driver中的probe为platform_drv_probe，实则最后调用的是drv-&gt;probe</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">platform_drv_probe(struct device *_dev)</span></span><br><span class="line"><span class="comment">    -&gt; dev = to_platform_device(_dev) //由struct deivce求 sturct platform_device</span></span><br><span class="line"><span class="comment">    -&gt; drv = to_platform_driver(_dev-&gt;driver) //由struct device_driver 求struct platform_driver</span></span><br><span class="line"><span class="comment">    -&gt; drv-&gt;probe(dev) //调用platform_driver中的probe,入参为platform_device</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">remove()和shutdown()同上</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">suspend()和resume()函数使用platform_driver-&gt;driver-&gt;pm中的</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


<h2 id="字符设备"><a href="#字符设备" class="headerlink" title="字符设备"></a>字符设备</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span>                           </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>               </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>              </span><br><span class="line">   <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span> </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>             </span><br><span class="line">   <span class="keyword">dev_t</span> dev;                         </span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">int</span> count;                </span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobj_map</span> &#123;</span>                      </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">probe</span> &#123;</span>                 </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">probe</span> *<span class="title">next</span>;</span>        </span><br><span class="line">        <span class="keyword">dev_t</span> dev;                 </span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> range;       </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>      </span><br><span class="line">        <span class="keyword">kobj_probe_t</span> *get;         </span><br><span class="line">        <span class="keyword">int</span> (*lock)(<span class="keyword">dev_t</span>, <span class="keyword">void</span> *);</span><br><span class="line">        <span class="keyword">void</span> *data;                </span><br><span class="line">    &#125; *probes[<span class="number">255</span>];                </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> *<span class="title">lock</span>;</span>            </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span> 字符设备中注册的<span class="title">ops</span>中的<span class="title">read</span>被<span class="title">SyS_read</span>调用</span></span><br></pre></td></tr></table></figure>


<h2 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h2><p>elf head 64bytes<br>readelf -h xx</p>
<h2 id="磁盘问题"><a href="#磁盘问题" class="headerlink" title="磁盘问题"></a>磁盘问题</h2><h3 id="4-19-kernel-HDD磁盘IO-block"><a href="#4-19-kernel-HDD磁盘IO-block" class="headerlink" title="4.19 kernel HDD磁盘IO block:"></a>4.19 kernel HDD磁盘IO block:</h3><p>‘strace iozone’ command: block in function: do_wait()<br>‘ls’ command: block in function io_schedule()<br>‘iozone’ command: block in function: submit_bio_wait()<br>###<br>交叉编译smartctl<br>./configure –host=arm-linux-gnueabihf –prefix=/home/songzhenhao/Work/disk/smartmontools-7.0/install –bindir=/home/songzhenhao/Work/disk/smartmontools-7.0/build/</p>
<h3 id="日志源码"><a href="#日志源码" class="headerlink" title="日志源码"></a>日志源码</h3><p><font color=#10099ff>“ata1: hard resetting link”</font> ata_eh_reset()<br>kthread()-&gt; scsi_host_alloc()-&gt;kthread_run(scsi_error_handler,…)// drivers/scsi/hosts.c<br>scsi_error_handler()-&gt; shost-&gt;transportt-&gt;eh_strategy_handler(shost) // drivers/scsi/scsi_error.c<br>(ata_attach_transport() (struct ata_internal *)i-&gt;t.eh_strategy_handler = ata_scsi_error // libata-transport.c)<br>ata_scsi_error()-&gt; // libata-eh.c<br>ata_scsi_port_error_handler() // libata-eh.c<br>ahci_error_handler()-&gt; // ahci_ops-&gt;error_handler // libahci.c<br>sata_pmp_error_handler()-&gt; // libata-pmp.c<br>ata_eh_recover()-&gt; //libata-eh.c<br>ata_eh_reset()</p>
<p><font color=#10099ff>“blk_update_request: I/O error, dev sda, sector 0”</font> //block/blk-core.c</p>
<p><font color=#10099ff>“ata1: SATA link up 1.5 Gbps (SStatus 113 SControl 310)”</font> //driver/ata/libata-core.c<br>   sata_print_link_status() //<br>      0x113:SATA_PxSSTS -&gt; Interface in ACTIVE state | 1.5Gbps | Device presence detected and PHY communication established<br>      0x310:SATA_PxSCTL -&gt; Transitions to both PARTIAL and SLUMBER states<br>disabled | Limit speed negotiation to generation 1<br>communication rate | No device detection or initialization action requested<br>sata_scr_read()<br>   -&gt;scr_read() //ahci_scr_read() //driver/ata/libahci.c ahci_ops-&gt;scr_read()<br>ahci_src_read() -&gt; port_mmio:0xfc140100 -&gt;0x4A140100 SATA_PxCLB<br>   cat /proc/vmallocinfo<br>   0xfc000000-0xfc300000 3145728 iotable_init+0x0/0xc4 phys=4a000000 ioremap<br>   即0xfc000000映射到0x4a000000<br>   DWC_ahstata:0x4A140000-&gt;0xfc140000<br>   devmem2 0x4A140128</p>
<p>ata_eh_reset() // libata-eh.c<br>ahci_postreset() //driver/ata/libahci.c ahci_ops-&gt;postreset<br>   -&gt;ata_std_postreset()<br>      -&gt;sata_print_link_status()</p>
<p>ata_set_mode()<br>-&gt;ata_dev_set_mode()<br><font color=#10099ff>“configure for UDMA/33”</font> //drivers/ata/libata-core.c/ata_dev_set_mode()</p>
<p>ata_scsi_error-&gt;<br>ata_scsi_port_error_handler()<br><font color=#10099ff>“EH complete” </font>//drivers/ata/libata-eh.c/ata_scsi_port_error_handler()</p>
<font color=#10099ff>
scsi 0:0:0:0: Direct-Access     ATA      ST1000LM048-2E71 SDM1 PQ: 0 ANSI: 5
</font> //scsi_add_lun() scsi/scsi_scan.c

<p>sd 0:0:0:0: [sda] 1953525168 512-byte logical blocks: (1.00 TB/932 GiB) //sd_read_capacity()<br>sd 0:0:0:0: [sda] 4096-byte physical blocks //sd_read_capacity<br>sd 0:0:0:0: [sda] Write Protect is off   //sd_read_write_protect_flag() scsi/sd.c<br>sd 0:0:0:0: [sda] Mode Sense: 00 3a 00 00 //sd_read_write_protect_flag() scsi/sd.c<br>sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn’t support DPO or FUA //sd_read_cache_type() scsi/sd.c<br> sda:<br>sd 0:0:0:0: [sda] Attached SCSI disk //sd_probe_async() scsi/sd.c</p>
<font color=#10099ff>
ata1.00: dev exception Emask 0x10 SAct 0x0 SErr 0x400101 action 0x6 frozen
</font> 
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// libata-eh.c ata_eh_link_report()</span><br><span class="line">void sata_pmp_error_handler(struct ata_port *ap)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO&quot;%s %d lr:0x%p %s\n&quot;,__func__, __LINE__, __builtin_return_address(0), __FILE__);</span><br><span class="line">    ata_eh_autopsy(ap);</span><br><span class="line">    ata_eh_report(ap);</span><br><span class="line">    sata_pmp_eh_recover(ap);</span><br><span class="line">    ata_eh_finish(ap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>shci_exec_polled_cmd() // write PORT_CMD_ISSUE 1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/* SATA Status and Control Registers */</span></span><br><span class="line">   <span class="comment">//ahci.h</span></span><br><span class="line">   SCR_STATUS      = <span class="number">0</span>,</span><br><span class="line">   SCR_ERROR       = <span class="number">1</span>,</span><br><span class="line">   SCR_CONTROL     = <span class="number">2</span>,</span><br><span class="line">   SCR_ACTIVE      = <span class="number">3</span>,</span><br><span class="line">   SCR_NOTIFICATION   = <span class="number">4</span>,</span><br><span class="line">   <span class="comment">/* registers for each SATA port */</span></span><br><span class="line">   PORT_LST_ADDR       = <span class="number">0x00</span>, <span class="comment">/* command list DMA addr */</span></span><br><span class="line">   PORT_LST_ADDR_HI    = <span class="number">0x04</span>, <span class="comment">/* command list DMA addr hi */</span></span><br><span class="line">   PORT_FIS_ADDR       = <span class="number">0x08</span>, <span class="comment">/* FIS rx buf addr */</span></span><br><span class="line">   PORT_FIS_ADDR_HI    = <span class="number">0x0c</span>, <span class="comment">/* FIS rx buf addr hi */</span></span><br><span class="line">   PORT_IRQ_STAT       = <span class="number">0x10</span>, <span class="comment">/* interrupt status */</span></span><br><span class="line">   PORT_IRQ_MASK       = <span class="number">0x14</span>, <span class="comment">/* interrupt enable/disable mask */</span></span><br><span class="line">   PORT_CMD        = <span class="number">0x18</span>, <span class="comment">/* port command */</span></span><br><span class="line">   PORT_TFDATA     = <span class="number">0x20</span>, <span class="comment">/* taskfile data */</span></span><br><span class="line">   PORT_SIG        = <span class="number">0x24</span>, <span class="comment">/* device TF signature */</span></span><br><span class="line">   PORT_CMD_ISSUE      = <span class="number">0x38</span>, <span class="comment">/* command issue */</span></span><br><span class="line">   PORT_SCR_STAT       = <span class="number">0x28</span>, <span class="comment">/* SATA phy register: SStatus */</span></span><br><span class="line">   PORT_SCR_CTL        = <span class="number">0x2c</span>, <span class="comment">/* SATA phy register: SControl */</span></span><br><span class="line">   PORT_SCR_ERR        = <span class="number">0x30</span>, <span class="comment">/* SATA phy register: SError */</span></span><br><span class="line">   PORT_SCR_ACT        = <span class="number">0x34</span>, <span class="comment">/* SATA phy register: SActive */</span></span><br><span class="line">   PORT_SCR_NTF        = <span class="number">0x3c</span>, <span class="comment">/* SATA phy register: SNotification */</span></span><br><span class="line">   PORT_FBS        = <span class="number">0x40</span>, <span class="comment">/* FIS-based Switching */</span></span><br><span class="line">   PORT_DEVSLP     = <span class="number">0x44</span>, <span class="comment">/* device sleep */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// ahci_src_offset() //libahci.c</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> offset[] = &#123;</span><br><span class="line">   [SCR_STATUS]        = PORT_SCR_STAT,</span><br><span class="line">   [SCR_CONTROL]       = PORT_SCR_CTL,</span><br><span class="line">   [SCR_ERROR]         = PORT_SCR_ERR,</span><br><span class="line">   [SCR_ACTIVE]        = PORT_SCR_ACT,</span><br><span class="line">   [SCR_NOTIFICATION]  = PORT_SCR_NTF,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>sata硬盘debug计划与进展:<br>###目标：</p>
<ol>
<li>找到4.9.59内核(PC机中正使用的内核)导致硬盘故障的原因并修复;</li>
<li>测试4.19.38内核(TI新发布SDK中的内核)是否导致会导致硬盘故障;</li>
</ol>
<p>###计划:</p>
<ul>
<li><ol>
<li><p>使用命令测试硬盘：(目标1)</p>
<ul>
<li>a. 4.19.38内核测试硬盘读写，4.9.59内核确定会导致硬盘故障，不再测试。</li>
<li>b. 使用命令”iozone -a -G 2G -C -r /run/media/sda1”测试硬盘，命令包括64kB~512M的文件的读写。（早前测试中该命令的执行会导致4.9.59内核出现磁盘故障）;</li>
<li>c. 使用自制AM5728板卡分别测试SSD和HDD;</li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>使用4.9.59内核，外购AM5728板卡，故障硬盘分析sata驱动源码；(目标2)<h3 id="进展"><a href="#进展" class="headerlink" title="进展"></a>进展</h3></li>
</ol>
</li>
<li><ol>
<li>计划1进行中，SSD跑了200次未故障；HDD跑了100次未故障;</li>
</ol>
</li>
<li><ol start="2">
<li>计划2进行中，分析sata驱动源码中，解读日志故障信息。</li>
</ol>
</li>
</ul>
<p>根据和吴工沟通得到的建议，结合目前测试得到的信息，有如下计划：</p>
<ul>
<li><ol>
<li>硬件同事对比两块板子的眼图，供电；</li>
</ol>
</li>
<li><ol start="2">
<li>用外购板卡beagleboard-x15测4.19.38内核测磁盘的稳定性；</li>
</ol>
</li>
<li><ol start="3">
<li>移植smartctl磁盘工具测试硬盘误码；</li>
</ol>
</li>
<li><ol start="4">
<li>继续分析sata驱动源码；</li>
</ol>
</li>
</ul>
<p>2019-09-18更新：</p>
<ul>
<li>1.未开始，参考2，可推断两块板卡没有明显能导致磁盘故障的差异；</li>
<li>2.故障硬盘使用beagleboard-x15+4.19.38内核可自动修复磁盘故障，自制5728板卡+4.19.38内核亦可自动修复；</li>
<li><ol start="3">
<li>smartclt完成移植，但暂未发现有用信息；对故障磁盘执行命令失败；</li>
</ol>
</li>
<li><ol start="4">
<li>源码持续跟踪中。</li>
</ol>
</li>
<li><ol start="5">
<li>4.19.38内核iozone命令测试未出问题，持续测试中。<br>由于上2/3可进一步推断4.19.38内核/驱动对4.9.59内核/驱动已有的sata问题做了修复，当目前尚不知具体的修复措施和效果，需要继续跟踪源码分析。<br>下一步工作计划：</li>
</ol>
</li>
<li><ol>
<li>继续使用iozone 命令测试4.19.38内核/驱动；</li>
</ol>
</li>
<li><ol start="2">
<li>持续跟踪源码分析驱动更改点及效果。</li>
</ol>
</li>
</ul>
<p>2019-09-20更新：</p>
<ul>
<li><ol>
<li>持续测试中暂未发生故障；</li>
</ol>
</li>
<li><ol start="2">
<li>持续阅读源码；<br>困难：<br>sata/ahci 协议理解不深，进度缓慢；</li>
</ol>
</li>
</ul>
<p>后续可行的操作包括：</p>
<ul>
<li><ol>
<li>升级使用4.19内核;</li>
</ol>
</li>
<li><ol start="2">
<li>强制限制sata1.5G速度;</li>
</ol>
</li>
<li><ol start="3">
<li>主动关闭NCQ功能;</li>
</ol>
</li>
</ul>
<p>beagleboard-x15+4.19.38内核 softreset failed, 无法修复硬盘<br>猜想：<br>硬件链路出错导致sata异常，链路恢复时，4.19可自动修复。4.9不可修复</p>
<p>2019-09-25 更新：</p>
<ul>
<li><ol>
<li>4.19新内核磁盘发生故障；<br>现象：<ol>
<li>无磁盘相关日志打印；只有如下打印<br>sysrq: SysRq : HELP : loglevel(0-9) reboot(b) crash(c) terminate-all-tasks(e) memory-full-oom-kill(f) kill-all-tasks(i) thaw-filesystems(j) sak(k) show-backtrace-all-active-cpus(l) show-memory-usage(m) nice-all-RT-tasks(n) poweroff(o) show-registers(p) show-all-timers(q) unraw(r) sync(s) show-task-states(t) unmount(u) force-fb(V) show-blocked-tasks(w)<br>echo e &gt; sysrq-trigger 无法终止iozone</li>
<li>所有与磁盘相关的应用卡死（CPU不调度），无法杀死进程；iozone /proc/pid/wchan 卡顿在block/bio.c submit_bio_wait()/  其他io操作卡顿在kernel/sched/core.c io_schedule()</li>
<li>重启后恢复；</li>
</ol>
</li>
</ol>
</li>
<li><ol start="2">
<li>4.9旧内核在beagleboard-x15上运行，更换新的esata线后暂未出现文件系统损坏故障，系统日志显示出现链路层错误，软件复位成功。<br>结合之前的故障日志可推测磁盘故障的原因有两个：</li>
</ol>
</li>
</ul>
<ol>
<li>硬件上的链路错误，在极端情况下4.9的内核驱动无法恢复；</li>
<li>系统性能瓶颈导致的故障，如4.19内核下磁盘操作被挂起。<br>下一步计划：</li>
<li>继续分析代码源码；</li>
<li>持续测试。</li>
</ol>
<p>2019-09-27 更新：</p>
<ul>
<li><ol>
<li>4.19内核使用SSD连续跑超过24小时，未出现磁盘相关应用卡死情况；完成100次iozone测试</li>
</ol>
</li>
<li><ol start="2">
<li>4.9内核使用HDD连续跑超过24小时，打印了3次，完成5次iozone测试<br>ata1.00: failed command: FLUSH CACHE EXT<br>结合吴工的意见，使用4.19内核对HDD高强度测试导致的的应用卡死，怀疑是IO调度相关问题，<br>下一步计划:</li>
</ol>
</li>
<li><ol>
<li>继续测试4.19+HDD/4.9+SSD;</li>
</ol>
</li>
<li><ol start="2">
<li>配置内核复现时trace io调用。</li>
</ol>
</li>
<li><ol start="3">
<li>后续考虑优化降低应用代码的IO操作，包括磁盘IO/USB/serial等。</li>
</ol>
</li>
</ul>
<p>2019-10-16 更新：</p>
<ul>
<li><ol>
<li>持续进行4.19/4.9内核+HDD的测试。国庆假后测试至今情况：<br>I. 4.19内核出现一次IO卡死，但debug环境不完整未trace到有效信息;<br>II. 4.9内核多次出现FLUSH CACHE EXT,但hard reset 成功，HDD文件系统未损坏；<br>下一步计划：</li>
</ol>
</li>
<li><ol>
<li>继续磁盘测试；</li>
</ol>
</li>
<li><ol start="2">
<li>配置完善内核debug/trace功能；</li>
</ol>
</li>
<li><ol start="3">
<li>部署工具进行系统性能测试，测性能瓶颈；<br>PMP (Port Multiplier )</li>
</ol>
</li>
</ul>
<p>##目标：</p>
<ul>
<li>设备树流程</li>
<li>v4l2</li>
<li>yocto</li>
<li>systemd</li>
<li>PCIe</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/18/Linux_SDK_Guide/guide/" data-id="ck1vxb1lc00030gh9dyg84w52" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/10/18/Linux_SDK_Guide/self_check/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Linux_SDK_Guide/self_check
        
      </div>
    </a>
  
  
    <a href="/2019/10/18/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/10/18/Linux_SDK_Guide/%E7%A1%AC%E7%9B%98%E6%95%85%E9%9A%9C/">Linux_SDK_Guide/硬盘故障</a>
          </li>
        
          <li>
            <a href="/2019/10/18/Linux_SDK_Guide/%E7%A1%AC%E7%9B%98%E6%95%85%E9%9A%9C/">Linux_SDK_Guide/硬盘故障</a>
          </li>
        
          <li>
            <a href="/2019/10/18/Linux_SDK_Guide/self_check/">Linux_SDK_Guide/self_check</a>
          </li>
        
          <li>
            <a href="/2019/10/18/Linux_SDK_Guide/guide/">Linux_SDK_Guide/guide</a>
          </li>
        
          <li>
            <a href="/2019/10/18/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>